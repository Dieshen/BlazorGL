@page "/examples/materials/showcase"
@inject IJSRuntime JSRuntime

<PageTitle>Material Showcase - BlazorGL Examples</PageTitle>

<div class="example-header">
    <h1>Material Showcase</h1>
    <p class="example-description">
        Compare all material types available in BlazorGL. Each material type has different
        properties and is suited for different use cases - from realistic PBR to stylized toon shading.
    </p>
</div>

<div class="example-content">
    <div class="example-main">
        <div class="canvas-container">
            <canvas @ref="canvasRef" width="1280" height="720"></canvas>
            <StatsOverlay Fps="@fps" FrameTime="@frameTime" DrawCalls="@drawCalls" Triangles="@triangles" />
        </div>

        <div class="material-selector">
            @foreach (var mat in materialTypes)
            {
                <button class="mat-btn @(selectedMaterial == mat.Key ? "active" : "")"
                        @onclick="() => SelectMaterial(mat.Key)">
                    @mat.Value.Name
                </button>
            }
        </div>
    </div>

    <div class="example-sidebar">
        <ParameterPanel Title="Material Info">
            <div class="material-info">
                <h4>@materialTypes[selectedMaterial].Name</h4>
                <p>@materialTypes[selectedMaterial].Description</p>
                <div class="use-cases">
                    <strong>Best for:</strong>
                    <span>@materialTypes[selectedMaterial].UseCase</span>
                </div>
            </div>
        </ParameterPanel>

        @if (selectedMaterial == "standard" || selectedMaterial == "physical")
        {
            <ParameterPanel Title="PBR Properties">
                <div class="param-row">
                    <label class="param-label">
                        <span>Roughness</span>
                        <span class="param-value">@roughness.ToString("F2")</span>
                    </label>
                    <input type="range" min="0" max="1" step="0.05" @bind="roughness" @bind:event="oninput" />
                </div>
                <div class="param-row">
                    <label class="param-label">
                        <span>Metalness</span>
                        <span class="param-value">@metalness.ToString("F2")</span>
                    </label>
                    <input type="range" min="0" max="1" step="0.05" @bind="metalness" @bind:event="oninput" />
                </div>
                @if (selectedMaterial == "physical")
                {
                    <div class="param-row">
                        <label class="param-label">
                            <span>Clearcoat</span>
                            <span class="param-value">@clearcoat.ToString("F2")</span>
                        </label>
                        <input type="range" min="0" max="1" step="0.05" @bind="clearcoat" @bind:event="oninput" />
                    </div>
                    <div class="param-row">
                        <label class="param-label">
                            <span>Transmission</span>
                            <span class="param-value">@transmission.ToString("F2")</span>
                        </label>
                        <input type="range" min="0" max="1" step="0.05" @bind="transmission" @bind:event="oninput" />
                    </div>
                }
            </ParameterPanel>
        }

        @if (selectedMaterial == "phong")
        {
            <ParameterPanel Title="Phong Properties">
                <div class="param-row">
                    <label class="param-label">
                        <span>Shininess</span>
                        <span class="param-value">@shininess.ToString("F0")</span>
                    </label>
                    <input type="range" min="1" max="200" step="5" @bind="shininess" @bind:event="oninput" />
                </div>
            </ParameterPanel>
        }

        @if (selectedMaterial == "toon")
        {
            <ParameterPanel Title="Toon Properties">
                <div class="param-row">
                    <label class="param-label">
                        <span>Gradient Steps</span>
                        <span class="param-value">@toonSteps</span>
                    </label>
                    <input type="range" min="2" max="8" step="1" @bind="toonSteps" @bind:event="oninput" />
                </div>
            </ParameterPanel>
        }

        <ParameterPanel Title="Color">
            <div class="param-row">
                <label class="param-label"><span>Base Color</span></label>
                <input type="color" value="@colorHex" @onchange="OnColorChange" />
            </div>
        </ParameterPanel>

        <ParameterPanel Title="Display">
            <div class="param-row">
                <label class="param-label"><span>Wireframe</span></label>
                <input type="checkbox" @bind="wireframe" />
            </div>
            <div class="param-row">
                <label class="param-label"><span>Auto Rotate</span></label>
                <input type="checkbox" @bind="autoRotate" />
            </div>
            <div class="param-row">
                <label class="param-label"><span>Show Sphere Grid</span></label>
                <input type="checkbox" @bind="showGrid" @bind:after="UpdateGrid" />
            </div>
        </ParameterPanel>
    </div>
</div>

<style>
    .material-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 16px;
        background: white;
        border-radius: 8px;
        margin-top: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .mat-btn {
        padding: 8px 14px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .mat-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .mat-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .material-info h4 {
        margin: 0 0 8px;
        color: #333;
    }

    .material-info p {
        font-size: 13px;
        color: #666;
        margin-bottom: 12px;
    }

    .use-cases {
        font-size: 12px;
        padding: 8px 12px;
        background: #f5f5f5;
        border-radius: 6px;
    }

    .use-cases strong {
        display: block;
        margin-bottom: 4px;
        color: #333;
    }

    .use-cases span {
        color: #666;
    }
</style>

@code {
    private ElementReference canvasRef;
    private Renderer? renderer;
    private Scene? scene;
    private PerspectiveCamera? camera;
    private Mesh? sphere;
    private List<Mesh> gridSpheres = new();
    private Material? currentMaterial;
    private bool isRunning = false;

    // Stats
    private float fps = 0;
    private float frameTime = 0;
    private int drawCalls = 1;
    private int triangles = 960;

    // Display
    private bool wireframe = false;
    private bool autoRotate = true;
    private bool showGrid = false;

    // Material params
    private string colorHex = "#4488ff";
    private float roughness = 0.5f;
    private float metalness = 0.3f;
    private float clearcoat = 0.0f;
    private float transmission = 0.0f;
    private float shininess = 30f;
    private int toonSteps = 4;

    private string selectedMaterial = "standard";

    private record MaterialInfo(string Name, string Description, string UseCase);

    private Dictionary<string, MaterialInfo> materialTypes = new()
    {
        ["standard"] = new("Standard (PBR)", "Physically-based rendering with metallic-roughness workflow. Industry standard for realistic materials.", "Realistic rendering, games, product visualization"),
        ["physical"] = new("Physical", "Extended PBR with clearcoat, transmission, and subsurface scattering.", "Glass, car paint, skin, gemstones"),
        ["basic"] = new("Basic", "Unlit material with flat color. No lighting calculations.", "UI elements, post-processing, performance-critical"),
        ["lambert"] = new("Lambert", "Diffuse-only shading. Matte surfaces without specular highlights.", "Matte materials, clay, fabric, paper"),
        ["phong"] = new("Phong", "Classic specular model with configurable shininess.", "Shiny plastic, legacy graphics, simple reflections"),
        ["toon"] = new("Toon", "Cel-shaded cartoon style with discrete shading bands.", "Anime, cartoons, stylized games"),
        ["normal"] = new("Normal", "Visualizes surface normals as RGB colors.", "Debugging, normal map visualization"),
        ["depth"] = new("Depth", "Visualizes depth values as grayscale.", "Debugging, depth-based effects"),
        ["matcap"] = new("Matcap", "Material capture using a sphere texture for lighting.", "Sculpting previews, stylized rendering"),
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeScene();
        }
    }

    private async Task InitializeScene()
    {
        try
        {
            renderer = new Renderer();
            await renderer.InitializeAsync(canvasRef, JSRuntime);
            renderer.SetSize(1280, 720);
            renderer.SetClearColor(new BlazorGL.Core.Math.Color(0.08f, 0.08f, 0.12f));

            scene = new Scene();

            camera = new PerspectiveCamera(50, 1280f / 720f, 0.1f, 100f);
            camera.Position = new Vector3(0, 0, 6);
            camera.LookAt(Vector3.Zero);

            // Add lights
            scene.Add(new AmbientLight(new BlazorGL.Core.Math.Color(0.3f, 0.3f, 0.35f), 0.6f));

            var keyLight = new DirectionalLight(new BlazorGL.Core.Math.Color(1f, 0.95f, 0.9f), 1.2f);
            keyLight.Position = new Vector3(5, 5, 5);
            scene.Add(keyLight);

            var fillLight = new DirectionalLight(new BlazorGL.Core.Math.Color(0.4f, 0.4f, 0.5f), 0.4f);
            fillLight.Position = new Vector3(-5, 2, -2);
            scene.Add(fillLight);

            var backLight = new DirectionalLight(new BlazorGL.Core.Math.Color(0.3f, 0.3f, 0.4f), 0.3f);
            backLight.Position = new Vector3(0, -3, -5);
            scene.Add(backLight);

            // Create main sphere
            var geometry = new SphereGeometry(1.5f, 64, 32);
            UpdateMaterial();
            sphere = new Mesh(geometry, currentMaterial!);
            scene.Add(sphere);

            isRunning = true;
            await RenderLoop();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void SelectMaterial(string key)
    {
        selectedMaterial = key;
        UpdateMaterial();
    }

    private void UpdateMaterial()
    {
        var color = HexToColor(colorHex);

        currentMaterial = selectedMaterial switch
        {
            "standard" => new StandardMaterial
            {
                Color = color,
                Roughness = roughness,
                Metalness = metalness,
                Wireframe = wireframe
            },
            "physical" => new PhysicalMaterial
            {
                Color = color,
                Roughness = roughness,
                Metalness = metalness,
                Clearcoat = clearcoat,
                Transmission = transmission,
                Wireframe = wireframe
            },
            "basic" => new BasicMaterial
            {
                Color = color,
                Wireframe = wireframe
            },
            "lambert" => new LambertMaterial
            {
                Color = color,
                Wireframe = wireframe
            },
            "phong" => new PhongMaterial
            {
                Color = color,
                Shininess = shininess,
                Wireframe = wireframe
            },
            "toon" => new ToonMaterial
            {
                Color = color,
                Wireframe = wireframe
            },
            "normal" => new NormalMaterial
            {
                Wireframe = wireframe
            },
            "depth" => new DepthMaterial
            {
                Wireframe = wireframe
            },
            "matcap" => new MatcapMaterial
            {
                Color = color,
                Wireframe = wireframe
            },
            _ => new StandardMaterial { Color = color }
        };

        if (sphere != null)
        {
            sphere.Material = currentMaterial;
        }

        // Update grid spheres too
        foreach (var gridSphere in gridSpheres)
        {
            gridSphere.Material = currentMaterial;
        }
    }

    private void UpdateGrid()
    {
        if (scene == null) return;

        // Remove existing grid
        foreach (var s in gridSpheres)
        {
            scene.Remove(s);
        }
        gridSpheres.Clear();

        if (showGrid && currentMaterial != null)
        {
            var smallGeo = new SphereGeometry(0.4f, 32, 16);

            for (int x = -2; x <= 2; x++)
            {
                for (int y = -1; y <= 1; y++)
                {
                    if (x == 0 && y == 0) continue; // Skip center

                    var s = new Mesh(smallGeo, currentMaterial);
                    s.Position = new Vector3(x * 1.5f, y * 1.5f, -2);
                    scene.Add(s);
                    gridSpheres.Add(s);
                }
            }
        }
    }

    private void OnColorChange(ChangeEventArgs e)
    {
        colorHex = e.Value?.ToString() ?? "#4488ff";
        UpdateMaterial();
    }

    private async Task RenderLoop()
    {
        var lastTime = DateTime.UtcNow;
        float angle = 0;

        while (isRunning)
        {
            var currentTime = DateTime.UtcNow;
            var deltaTime = (float)(currentTime - lastTime).TotalMilliseconds;
            lastTime = currentTime;

            fps = deltaTime > 0 ? 1000f / deltaTime : 0;
            frameTime = deltaTime;

            // Update material properties dynamically
            if (currentMaterial is StandardMaterial std)
            {
                std.Roughness = roughness;
                std.Metalness = metalness;
                std.Wireframe = wireframe;
            }
            else if (currentMaterial is PhysicalMaterial phys)
            {
                phys.Roughness = roughness;
                phys.Metalness = metalness;
                phys.Clearcoat = clearcoat;
                phys.Transmission = transmission;
                phys.Wireframe = wireframe;
            }
            else if (currentMaterial is PhongMaterial phong)
            {
                phong.Shininess = shininess;
                phong.Wireframe = wireframe;
            }
            else if (currentMaterial != null)
            {
                currentMaterial.Wireframe = wireframe;
            }

            // Rotate
            if (sphere != null && autoRotate)
            {
                angle += 0.01f;
                sphere.Rotation = new Vector3(angle * 0.3f, angle, 0);
            }

            renderer?.Render(scene!, camera!);
            drawCalls = 1 + gridSpheres.Count;

            StateHasChanged();
            await Task.Delay(16);
        }
    }

    private BlazorGL.Core.Math.Color HexToColor(string hex)
    {
        hex = hex.TrimStart('#');
        if (hex.Length == 6)
        {
            int r = Convert.ToInt32(hex.Substring(0, 2), 16);
            int g = Convert.ToInt32(hex.Substring(2, 2), 16);
            int b = Convert.ToInt32(hex.Substring(4, 2), 16);
            return new BlazorGL.Core.Math.Color(r / 255f, g / 255f, b / 255f);
        }
        return new BlazorGL.Core.Math.Color(0.27f, 0.53f, 1f);
    }

    public void Dispose()
    {
        isRunning = false;
    }
}
