@page "/examples/controls/orbit"
@inject IJSRuntime JSRuntime

<PageTitle>Orbit Controls - BlazorGL Examples</PageTitle>

<div class="example-header">
    <h1>Orbit Controls</h1>
    <p class="example-description">
        Orbit controls allow you to rotate, pan, and zoom the camera around a target point.
        Click and drag to rotate, right-click to pan, scroll to zoom.
    </p>
</div>

<div class="example-content">
    <div class="example-main">
        <div class="canvas-container">
            <canvas @ref="canvasRef" id="orbit-canvas" width="1280" height="720"></canvas>
            <StatsOverlay Fps="@fps" FrameTime="@frameTime" DrawCalls="@drawCalls" Triangles="@triangles" />

            <div class="controls-hint">
                <span>üñ±Ô∏è Left: Rotate</span>
                <span>üñ±Ô∏è Right: Pan</span>
                <span>üñ±Ô∏è Scroll: Zoom</span>
            </div>
        </div>
    </div>

    <div class="example-sidebar">
        <ParameterPanel Title="Orbit Settings">
            <div class="param-row">
                <label class="param-label"><span>Enable Rotate</span></label>
                <input type="checkbox" @bind="enableRotate" />
            </div>
            <div class="param-row">
                <label class="param-label"><span>Enable Zoom</span></label>
                <input type="checkbox" @bind="enableZoom" />
            </div>
            <div class="param-row">
                <label class="param-label"><span>Enable Pan</span></label>
                <input type="checkbox" @bind="enablePan" />
            </div>
            <div class="param-row">
                <label class="param-label"><span>Auto Rotate</span></label>
                <input type="checkbox" @bind="autoRotate" />
            </div>
            <div class="param-row">
                <label class="param-label">
                    <span>Auto Rotate Speed</span>
                    <span class="param-value">@autoRotateSpeed.ToString("F1")</span>
                </label>
                <input type="range" min="0.5" max="5" step="0.5" @bind="autoRotateSpeed" @bind:event="oninput" />
            </div>
        </ParameterPanel>

        <ParameterPanel Title="Limits">
            <div class="param-row">
                <label class="param-label">
                    <span>Min Distance</span>
                    <span class="param-value">@minDistance.ToString("F1")</span>
                </label>
                <input type="range" min="1" max="5" step="0.5" @bind="minDistance" @bind:event="oninput" />
            </div>
            <div class="param-row">
                <label class="param-label">
                    <span>Max Distance</span>
                    <span class="param-value">@maxDistance.ToString("F1")</span>
                </label>
                <input type="range" min="10" max="50" step="5" @bind="maxDistance" @bind:event="oninput" />
            </div>
            <div class="param-row">
                <label class="param-label">
                    <span>Min Polar Angle</span>
                    <span class="param-value">@minPolarAngle.ToString("F0")¬∞</span>
                </label>
                <input type="range" min="0" max="90" step="5" @bind="minPolarAngle" @bind:event="oninput" />
            </div>
            <div class="param-row">
                <label class="param-label">
                    <span>Max Polar Angle</span>
                    <span class="param-value">@maxPolarAngle.ToString("F0")¬∞</span>
                </label>
                <input type="range" min="90" max="180" step="5" @bind="maxPolarAngle" @bind:event="oninput" />
            </div>
        </ParameterPanel>

        <ParameterPanel Title="Damping">
            <div class="param-row">
                <label class="param-label"><span>Enable Damping</span></label>
                <input type="checkbox" @bind="enableDamping" />
            </div>
            <div class="param-row">
                <label class="param-label">
                    <span>Damping Factor</span>
                    <span class="param-value">@dampingFactor.ToString("F2")</span>
                </label>
                <input type="range" min="0.01" max="0.3" step="0.01" @bind="dampingFactor" @bind:event="oninput" />
            </div>
        </ParameterPanel>

        <ParameterPanel Title="Actions">
            <button class="btn btn-secondary" style="width:100%; margin-bottom: 8px;" @onclick="ResetCamera">
                Reset Camera
            </button>
            <button class="btn btn-secondary" style="width:100%;" @onclick="FocusOnObject">
                Focus on Object
            </button>
        </ParameterPanel>
    </div>
</div>

<style>
    .controls-hint {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 8px;
        color: white;
        font-size: 13px;
    }
</style>

@code {
    private ElementReference canvasRef;
    private Renderer? renderer;
    private Scene? scene;
    private PerspectiveCamera? camera;
    private OrbitControls? controls;
    private bool isRunning = false;

    // Stats
    private float fps = 0;
    private float frameTime = 0;
    private int drawCalls = 5;
    private int triangles = 500;

    // Orbit settings
    private bool enableRotate = true;
    private bool enableZoom = true;
    private bool enablePan = true;
    private bool autoRotate = false;
    private float autoRotateSpeed = 2.0f;

    // Limits
    private float minDistance = 2f;
    private float maxDistance = 30f;
    private float minPolarAngle = 0f;
    private float maxPolarAngle = 180f;

    // Damping
    private bool enableDamping = true;
    private float dampingFactor = 0.05f;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeScene();
        }
    }

    private async Task InitializeScene()
    {
        try
        {
            renderer = new Renderer();
            await renderer.InitializeAsync(canvasRef, JSRuntime);
            renderer.SetSize(1280, 720);
            renderer.SetClearColor(new BlazorGL.Core.Math.Color(0.1f, 0.1f, 0.15f));

            scene = new Scene();

            camera = new PerspectiveCamera(60, 1280f / 720f, 0.1f, 1000f);
            camera.Position = new Vector3(5, 5, 10);

            // Initialize orbit controls
            controls = new OrbitControls(camera, JSRuntime, "orbit-canvas");
            controls.Target = Vector3.Zero;
            controls.EnableDamping = enableDamping;
            controls.DampingFactor = dampingFactor;
            await controls.InitializeAsync();

            // Add lights
            scene.Add(new AmbientLight(new BlazorGL.Core.Math.Color(0.4f, 0.4f, 0.4f), 0.5f));

            var light1 = new DirectionalLight(new BlazorGL.Core.Math.Color(1f, 1f, 1f), 1.0f);
            light1.Position = new Vector3(10, 10, 10);
            scene.Add(light1);

            var light2 = new DirectionalLight(new BlazorGL.Core.Math.Color(0.3f, 0.3f, 0.4f), 0.5f);
            light2.Position = new Vector3(-5, 5, -5);
            scene.Add(light2);

            // Add grid
            var grid = new GridHelper(20, 20);
            scene.Add(grid);

            // Add axes helper
            var axes = new AxesHelper(3);
            scene.Add(axes);

            // Create various objects to orbit around
            CreateSceneObjects();

            isRunning = true;
            await RenderLoop();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void CreateSceneObjects()
    {
        if (scene == null) return;

        // Central object
        var centerGeo = new TorusKnotGeometry(1, 0.3f, 128, 16, 2, 3);
        var centerMat = new StandardMaterial
        {
            Color = new BlazorGL.Core.Math.Color(0.4f, 0.6f, 1.0f),
            Roughness = 0.3f,
            Metalness = 0.7f
        };
        var center = new Mesh(centerGeo, centerMat);
        center.Position = new Vector3(0, 1, 0);
        scene.Add(center);

        // Surrounding objects
        var colors = new[]
        {
            new BlazorGL.Core.Math.Color(1f, 0.4f, 0.4f),
            new BlazorGL.Core.Math.Color(0.4f, 1f, 0.4f),
            new BlazorGL.Core.Math.Color(1f, 1f, 0.4f),
            new BlazorGL.Core.Math.Color(1f, 0.4f, 1f),
        };

        for (int i = 0; i < 4; i++)
        {
            float angle = i * MathF.PI / 2;
            var boxGeo = new BoxGeometry(1, 1, 1);
            var boxMat = new StandardMaterial
            {
                Color = colors[i],
                Roughness = 0.5f,
                Metalness = 0.3f
            };
            var box = new Mesh(boxGeo, boxMat);
            box.Position = new Vector3(
                MathF.Cos(angle) * 4,
                0.5f,
                MathF.Sin(angle) * 4
            );
            scene.Add(box);
        }
    }

    private async Task RenderLoop()
    {
        var lastTime = DateTime.UtcNow;

        while (isRunning)
        {
            var currentTime = DateTime.UtcNow;
            var deltaTime = (float)(currentTime - lastTime).TotalMilliseconds;
            lastTime = currentTime;

            fps = deltaTime > 0 ? 1000f / deltaTime : 0;
            frameTime = deltaTime;

            // Update controls settings
            if (controls != null)
            {
                controls.EnableRotate = enableRotate;
                controls.EnableZoom = enableZoom;
                controls.EnablePan = enablePan;
                controls.AutoRotate = autoRotate;
                controls.AutoRotateSpeed = autoRotateSpeed;
                controls.MinDistance = minDistance;
                controls.MaxDistance = maxDistance;
                controls.MinPolarAngle = minPolarAngle * MathF.PI / 180f;
                controls.MaxPolarAngle = maxPolarAngle * MathF.PI / 180f;
                controls.EnableDamping = enableDamping;
                controls.DampingFactor = dampingFactor;

                controls.Update(deltaTime / 1000f);
            }

            renderer?.Render(scene!, camera!);

            StateHasChanged();
            await Task.Delay(16);
        }
    }

    private void ResetCamera()
    {
        if (camera != null && controls != null)
        {
            camera.Position = new Vector3(5, 5, 10);
            controls.Target = Vector3.Zero;
            controls.Update(0);
        }
    }

    private void FocusOnObject()
    {
        if (controls != null)
        {
            controls.Target = new Vector3(0, 1, 0);
        }
    }

    public async ValueTask DisposeAsync()
    {
        isRunning = false;
        if (controls != null)
        {
            await controls.DisposeAsync();
        }
    }
}
